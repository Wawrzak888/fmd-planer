<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Diety Kulturystycznej</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        .toast {
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        input:disabled, select:disabled {
            background-color: #4A5568; /* bg-gray-600 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* Style for search suggestions */
        .suggestions-container {
            position: absolute;
            z-index: 10;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: #2d3748; /* bg-gray-700 */
            border: 1px solid #4a5568; /* border-gray-600 */
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #4a5568; /* bg-gray-600 */
        }

        /* --- NOWE STYLE DLA ZWIJANYCH POSIŁKÓW --- */
        .meal-content {
            max-height: 1000px; /* Duża wartość dla stanu rozwiniętego */
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .meal-content.collapsed {
            max-height: 0;
        }
        .meal-header .chevron {
            transition: transform 0.3s ease-in-out;
        }
        .meal-header.collapsed .chevron {
            transform: rotate(-90deg);
        }

        /* --- NOWE STYLE DLA ZWIJANEJ LISTY PRODUKTÓW --- */
        .product-category-header .chevron {
            transition: transform 0.3s ease-in-out;
        }
        .product-category-header.collapsed .chevron {
            transform: rotate(-90deg);
        }
        .product-category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Kalkulator Diety Hipertroficznej</h1>
            <p class="text-gray-400 mt-2">Zoptymalizuj swoją dietę w oparciu o badania naukowe na kulturystach.</p>
        </header>

        <main class="space-y-8">
            <!-- Sekcja profilu użytkownika (teraz tylko do wyświetlania) -->
            <section id="user-profile" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-cyan-300">Witaj, <span id="user-name-display"></span>!</h2>
                    <div class="flex gap-2">
                         <button id="edit-data-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Zmień dane</button>
                         <button id="clear-data-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Wyczyść dane</button>
                    </div>
                </div>
            </section>

            <!-- Sekcja danych użytkownika (teraz zawiera imię) -->
            <section id="user-data" class="bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                <h2 class="text-2xl font-bold text-cyan-300 mb-6 text-center">1. Wprowadź swoje parametry</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                       <label for="user-name" class="block text-sm font-medium text-gray-300 mb-2">Twoje imię</label>
                       <input type="text" id="user-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="np. Tomasz">
                    </div>
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-300 mb-2">Płeć</label>
                        <select id="gender" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <option value="male">Mężczyzna</option>
                            <option value="female">Kobieta</option>
                        </select>
                    </div>
                    <div>
                        <label for="age" class="block text-sm font-medium text-gray-300 mb-2">Wiek</label>
                        <input type="number" id="age" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="np. 30">
                    </div>
                     <div>
                        <label for="height" class="block text-sm font-medium text-gray-300 mb-2">Wzrost (cm)</label>
                        <input type="number" id="height" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="np. 180">
                    </div>
                    <div>
                        <label for="weight" class="block text-sm font-medium text-gray-300 mb-2">Twoja waga (kg)</label>
                        <input type="number" id="weight" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="np. 85">
                    </div>
                    <div class="md:col-span-2">
                        <label for="activity" class="block text-sm font-medium text-gray-300 mb-2">Współczynnik aktywności (PAL)</label>
                        <select id="activity" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <option value="1.2">Praca siedząca, brak aktywności</option>
                            <option value="1.4">Praca siedząca + 1-3 lekkie treningi</option>
                            <option value="1.6" selected>Praca siedząca + 3-5 intensywnych treningów</option>
                            <option value="1.8">Praca fizyczna + 3-5 treningów</option>
                            <option value="2.0">Bardzo ciężka praca fizyczna lub codzienne treningi</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                         <label for="goal" class="block text-sm font-medium text-gray-300 mb-2">Cel: Tempo przyrostu masy ciała</label>
                        <select id="goal" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <option value="0.25">Ostrożna masa (0.25% na tydzień) - minimalizacja tłuszczu</option>
                            <option value="0.5" selected>Optymalna masa (0.5% na tydzień) - zbalansowany wzrost</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button id="calculate-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">Zapisz i Oblicz</button>
                </div>
            </section>

            <!-- Sekcja wyników -->
            <section id="results" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                 <h2 class="text-2xl font-bold text-cyan-300 mb-6 text-center">2. Twoje dzienne zapotrzebowanie</h2>
                 <div class="text-center bg-gray-900 p-6 rounded-xl mb-6">
                    <p class="text-gray-400 text-lg">Cel kaloryczny</p>
                    <p id="total-calories" class="text-4xl font-bold text-white">0 kcal</p>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-emerald-900/50 p-4 rounded-lg">
                        <p class="font-bold text-emerald-300">Białko</p>
                        <p id="protein-grams" class="text-2xl font-semibold">0 g</p>
                        <p class="text-sm text-gray-400">(2.0 g/kg m.c.)</p>
                    </div>
                     <div class="bg-amber-900/50 p-4 rounded-lg">
                        <p class="font-bold text-amber-300">Węglowodany</p>
                        <p id="carbs-grams" class="text-2xl font-semibold">0 g</p>
                        <p class="text-sm text-gray-400">(Reszta energii)</p>
                    </div>
                     <div class="bg-rose-900/50 p-4 rounded-lg">
                        <p class="font-bold text-rose-300">Tłuszcze</p>
                        <p id="fat-grams" class="text-2xl font-semibold">0 g</p>
                        <p class="text-sm text-gray-400">(1.0 g/kg m.c.)</p>
                    </div>
                 </div>
                 <div class="mt-6 text-xs text-center text-gray-500">
                    <p>Powyższe makroskładniki są zgodne z zaleceniami ISSN: Białko 1.6-2.2 g/kg, Tłuszcze 0.5-1.5 g/kg, reszta kalorii z węglowodanów.</p>
                 </div>
            </section>
            
            <!-- Sekcja planera diety -->
            <section id="diet-planner" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-cyan-300 text-center sm:text-left">3. Skomponuj swoją dietę</h2>
                    <div class="flex gap-2">
                        <button id="add-meal-separator-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Nowy Posiłek</button>
                        <button id="clear-day-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Wyczyść Dzień</button>
                    </div>
                </div>
                <p class="text-center text-gray-400 -mt-4 mb-6 text-sm">Dodawaj produkty do listy. Użyj przycisku "Nowy Posiłek", aby oddzielić śniadanie, obiad, kolację itd.</p>
                
                <!-- Podsumowanie makro -->
                <div class="bg-gray-900 p-4 rounded-xl mb-6 space-y-3 sticky top-4 z-20">
                    <div>
                        <div class="flex justify-between items-baseline mb-1"><span class="font-medium text-gray-300">Kalorie</span><span class="text-sm" id="current-calories">0 / 0 kcal</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-2"><div id="calories-progress" class="bg-cyan-400 h-2 rounded-full progress-bar" style="width: 0%"></div></div>
                    </div>
                     <div>
                        <div class="flex justify-between items-baseline mb-1"><span class="font-medium text-gray-300">Białko</span><span class="text-sm" id="current-protein">0 / 0 g</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-2"><div id="protein-progress" class="bg-emerald-400 h-2 rounded-full progress-bar" style="width: 0%"></div></div>
                    </div>
                     <div>
                        <div class="flex justify-between items-baseline mb-1"><span class="font-medium text-gray-300">Węglowodany</span><span class="text-sm" id="current-carbs">0 / 0 g</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-2"><div id="carbs-progress" class="bg-amber-400 h-2 rounded-full progress-bar" style="width: 0%"></div></div>
                    </div>
                     <div>
                        <div class="flex justify-between items-baseline mb-1"><span class="font-medium text-gray-300">Tłuszcze</span><span class="text-sm" id="current-fat">0 / 0 g</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-2"><div id="fat-progress" class="bg-rose-400 h-2 rounded-full progress-bar" style="width: 0%"></div></div>
                    </div>
                </div>

                <!-- Dodawanie produktu -->
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="relative flex-grow">
                        <input type="text" id="product-search" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="Wyszukaj produkt..." autocomplete="off">
                        <div id="product-suggestions" class="hidden suggestions-container"></div>
                    </div>
                    <input type="number" id="product-amount" class="md:w-32 bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="Ilość (g)">
                    <button id="add-product-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">Dodaj</button>
                </div>

                <p class="text-center text-gray-500 text-xs -mt-4 mb-4">Wartości makroskładników są orientacyjne i mogą się różnić w zależności od producenta oraz sposobu przygotowania produktu.</p>

                <!-- Przycisk do dodawania własnych produktów -->
                <div class="text-center mb-6 flex flex-wrap justify-center gap-4">
                    <button id="open-composer-btn" class="text-emerald-400 hover:text-emerald-300 text-sm font-medium transition-colors">Skomponuj własny posiłek</button>
                    <button id="open-modal-btn" class="text-cyan-400 hover:text-cyan-300 text-sm font-medium transition-colors">Dodaj prosty produkt</button>
                    <button id="show-product-list-btn" class="text-purple-400 hover:text-purple-300 text-sm font-medium transition-colors">Pokaż listę produktów</button>
                </div>

                <!-- Lista posiłków -->
                <div id="meal-list" class="space-y-4">
                    <p class="text-center text-gray-500">Twoja lista posiłków jest pusta.</p>
                </div>
                <div class="mt-6">
                    <button id="export-pdf-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Eksportuj Dzienny Plan do PDF</button>
                </div>
            </section>

            <!-- Sekcja Kluczowych Zasad -->
            <section id="key-principles" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                <h2 class="text-2xl font-bold text-cyan-300 mb-6 text-center">4. Kluczowe Zasady i Strategie</h2>
                <div class="space-y-3 accordion-container">
                    <div>
                        <button class="accordion-btn w-full text-left flex justify-between items-center p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <span class="font-bold">Timing Posiłków: Mit "Okna Anabolicznego"</span>
                            <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content px-4 text-sm text-gray-300">
                            <p class="py-3">Tradycyjna koncepcja 30-minutowego "okna anabolicznego" jest przestarzała. Badania wskazują, że synteza białek mięśniowych jest podwyższona przez co najmniej 24 godziny po treningu. Kluczowe jest spożycie posiłku bogatego w białko w szerokim, 4-6 godzinnym "oknie" wokół treningu. Jeśli zjadłeś posiłek 1-2h przed treningiem, nie musisz spieszyć się z szejkiem bezpośrednio po nim.</p>
                        </div>
                    </div>
                    <div>
                        <button class="accordion-btn w-full text-left flex justify-between items-center p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <span class="font-bold">Częstotliwość Posiłków i Próg Leucynowy</span>
                            <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content px-4 text-sm text-gray-300">
                            <p class="py-3">Aby maksymalizować syntezę białek mięśniowych (MPS) w ciągu dnia, rozłóż dzienne spożycie białka na 3 do 6 posiłków. Każdy posiłek powinien zawierać 20-40g wysokiej jakości białka. Taka ilość zapewnia osiągnięcie tzw. "progu leucynowego" (ok. 3g leucyny), który jest sygnałem do rozpoczęcia procesów anabolicznych.</p>
                        </div>
                    </div>
                    <div>
                        <button class="accordion-btn w-full text-left flex justify-between items-center p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <span class="font-bold">Rola Mikroelementów</span>
                            <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content px-4 text-sm text-gray-300">
                            <p class="py-3">Makroskładniki to nie wszystko. Intensywny trening zwiększa zapotrzebowanie na witaminy i minerały. Zadbaj o podaż witaminy D, witamin z grupy B, magnezu, cynku i żelaza. Niedobory mogą hamować postępy, upośledzać regenerację i produkcję hormonów anabolicznych.</p>
                        </div>
                    </div>
                </div>
            </section>

             <!-- Sekcja Suplementacji -->
            <section id="supplementation" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                <h2 class="text-2xl font-bold text-cyan-300 mb-6 text-center">5. Hierarchia Suplementacji</h2>
                <div class="space-y-3 accordion-container">
                    <h3 class="font-bold text-lg text-emerald-300 pt-2">Poziom 1: Fundamentalne i Udowodnione</h3>
                    <div>
                        <button class="accordion-btn w-full text-left flex justify-between items-center p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <span class="font-bold">Monohydrat Kreatyny</span>
                            <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content px-4 text-sm text-gray-300">
                            <p class="py-3"><b>Działanie:</b> Najlepiej przebadany suplement. Zwiększa siłę i wytrzymałość, pozwalając na cięższy trening. <b>Dawkowanie:</b> 3-5 gramów dziennie, stała suplementacja.</p>
                        </div>
                    </div>
                    <div>
                        <button class="accordion-btn w-full text-left flex justify-between items-center p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <span class="font-bold">Białko serwatkowe</span>
                            <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content px-4 text-sm text-gray-300">
                            <p class="py-3"><b>Działanie:</b> Wygodne narzędzie do uzupełnienia dziennego zapotrzebowania na białko. Nie jest magiczne, ale niezwykle praktyczne. <b>Dawkowanie:</b> 1-2 porcje dziennie, w zależności od braków w diecie.</p>
                        </div>
                    </div>
                     <h3 class="font-bold text-lg text-amber-300 pt-4">Poziom 2: Wsparcie Wydajności</h3>
                     <div>
                        <button class="accordion-btn w-full text-left flex justify-between items-center p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <span class="font-bold">Cytrulina</span>
                            <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content px-4 text-sm text-gray-300">
                            <p class="py-3"><b>Działanie:</b> Poprawia przepływ krwi, zwiększa "pompę mięśniową" i może redukować bolesność mięśni. <b>Dawkowanie:</b> 6-8 g jabłczanu cytruliny na 30-60 min przed treningiem.</p>
                        </div>
                    </div>
                     <h3 class="font-bold text-lg text-rose-300 pt-4">Poziom 3: Wątpliwa Skuteczność u Osób Wytrenowanych</h3>
                     <div>
                        <button class="accordion-btn w-full text-left flex justify-between items-center p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                            <span class="font-bold">BCAA / HMB / Boostery Testosteronu</span>
                            <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content px-4 text-sm text-gray-300">
                            <p class="py-3"><b>Stan wiedzy:</b> Dla osób spożywających odpowiednią ilość białka, BCAA i HMB nie przynoszą dodatkowych korzyści. Skuteczność "naturalnych boosterów testosteronu" u zdrowych osób jest znikoma lub żadna. Inwestycja w te suplementy jest generalnie nieuzasadniona.</p>
                        </div>
                    </div>
                </div>
            </section>

             <!-- Sekcja Nawodnienia -->
            <section id="hydration" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                <h2 class="text-2xl font-bold text-cyan-300 mb-6 text-center">6. Strategia Nawodnienia</h2>
                <div class="text-center text-gray-300 bg-gray-900 p-6 rounded-xl">
                    <p class="text-lg">Odwodnienie na poziomie 2% masy ciała może drastycznie obniżyć Twoją wydajność.</p>
                    <p class="text-2xl font-bold text-white my-3">Pij 1 ml wody na każdą 1 kcal diety.</p>
                    <p>Przy diecie 3500 kcal, powinieneś wypijać 3.5 litra wody dziennie. Monitoruj kolor moczu - powinien być jasnożółty.</p>
                </div>
            </section>
        </main>

        <!-- Modal do dodawania PROSTEGO produktu -->
        <div id="custom-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6">
                 <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-cyan-300">Dodaj prosty produkt</h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <form id="custom-product-form" class="space-y-4">
                    <div>
                        <label for="new-product-name" class="block text-sm font-medium text-gray-300 mb-2">Nazwa produktu</label>
                        <input type="text" id="new-product-name" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="np. Ser twarogowy X">
                    </div>
                    <!-- ZMIANA START: Dodano pole wyboru kategorii -->
                    <div>
                        <label for="new-product-category" class="block text-sm font-medium text-gray-300 mb-2">Kategoria</label>
                        <select id="new-product-category" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <!-- Opcje generowane dynamicznie przez JS -->
                        </select>
                    </div>
                    <div id="new-category-wrapper" class="hidden">
                        <label for="new-product-new-category" class="block text-sm font-medium text-gray-300 mb-2">Nazwa nowej kategorii</label>
                        <input type="text" id="new-product-new-category" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="np. Słodycze">
                    </div>
                    <!-- ZMIANA KONIEC -->
                    <p class="text-sm text-gray-400 text-center !pt-2">Wartości odżywcze na 100g</p>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label for="new-product-protein" class="block text-sm font-medium text-gray-300 mb-2">Białko (g)</label>
                            <input type="number" step="0.1" id="new-product-protein" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                        </div>
                        <div>
                            <label for="new-product-carbs" class="block text-sm font-medium text-gray-300 mb-2">Węglow. (g)</label>
                            <input type="number" step="0.1" id="new-product-carbs" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                        </div>
                        <div>
                            <label for="new-product-fat" class="block text-sm font-medium text-gray-300 mb-2">Tłuszcz (g)</label>
                            <input type="number" step="0.1" id="new-product-fat" required class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-colors !mt-6">Zapisz produkt</button>
                </form>
            </div>
        </div>

        <!-- Modal do KOMPONOWANIA posiłku -->
        <div id="meal-composer-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-4xl p-6 overflow-y-auto max-h-[90vh]">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-emerald-300">Kalkulator Komponowania Dań Zup</h3>
                    <button id="close-composer-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Lewa strona: Składniki -->
                    <div>
                        <h4 class="text-lg font-bold mb-4">Składniki posiłku:</h4>
                        <div id="composer-ingredients-container" class="space-y-2">
                            <!-- Wiersze na składniki będą generowane przez JS -->
                        </div>
                    </div>
                    <!-- Prawa strona: Podsumowanie i zapis -->
                    <div class="bg-gray-900 p-6 rounded-lg">
                        <h4 class="text-lg font-bold mb-4">Podsumowanie posiłku:</h4>
                        <div id="composer-summary" class="space-y-2 text-lg mb-6">
                            <div class="flex justify-between"><span>Kalorie:</span><span class="font-bold">0 kcal</span></div>
                            <div class="flex justify-between"><span>Białko:</span><span class="font-bold">0 g</span></div>
                            <div class="flex justify-between"><span>Węglowodany:</span><span class="font-bold">0 g</span></div>
                            <div class="flex justify-between"><span>Tłuszcze:</span><span class="font-bold">0 g</span></div>
                        </div>
                        <div class="space-y-4 border-t border-gray-700 pt-6">
                            <div>
                               <label for="composer-meal-name" class="block text-sm font-medium text-gray-300 mb-2">Nazwa gotowego posiłku</label>
                               <input type="text" id="composer-meal-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-emerald-500 focus:outline-none" placeholder="np. Zupa pomidorowa Tomka">
                            </div>
                            <!-- NOWY UKRYTY INPUT DO PRZECHOWYWANIA ORYGINALNEJ NAZWY PODCZAS EDYCJI -->
                            <input type="hidden" id="composer-original-name">
                            <button id="save-composed-meal-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Zapisz posiłek na liście produktów</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal z pełną listą produktów -->
        <div id="product-list-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl p-6 flex flex-col max-h-[90vh]">
                 <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <h3 class="text-xl font-bold text-purple-400">Pełna Lista Produktów</h3>
                    <button id="close-product-list-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div id="modal-product-list-content" class="overflow-y-auto space-y-4">
                    <!-- Content generated by JS -->
                </div>
            </div>
        </div>


        <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2"></div>

        <footer class="text-center mt-12 text-gray-600 text-sm space-y-1">
            <p>Tomasz Wawrzak &copy; 2025</p>
            <p class="text-xs">Opracowano na podstawie zaleceń wiodących organizacji, takich jak International Society of Sports Nutrition (ISSN) i Instytut Żywności i Żywienia (IŻŻ), oraz metaanaliz badań z zakresu fizjologii hipertrofii.</p>
        </footer>

    </div>

    <script>
        // --- BAZA PRODUKTÓW (na 100g) ---
        const initialFoodProducts = [
            // Mięsa
            { name: 'Pierś z kurczaka', category: 'Mięsa', calories: 165, protein: 31, fat: 3.6, carbs: 0 },
            { name: 'Pierś z indyka', category: 'Mięsa', calories: 135, protein: 29, carbs: 0, fat: 1.7 },
            { name: 'Schab wieprzowy', category: 'Mięsa', calories: 242, protein: 27, fat: 14, carbs: 0 },
            { name: 'Wołowina (mielona chuda)', category: 'Mięsa', calories: 217, protein: 26, carbs: 0, fat: 12 },
            { name: 'Wołowina (rostbef)', category: 'Mięsa', calories: 155, protein: 28.7, carbs: 0, fat: 3.9 },
            { name: 'Wołowina (udziec)', category: 'Mięsa', calories: 201, protein: 28, fat: 9, carbs: 0 },
            // Wędliny
            { name: 'Boczek wędzony', category: 'Wędliny', calories: 510, protein: 15, fat: 50, carbs: 0 },
            { name: 'Kabanosy (wieprzowe)', category: 'Wędliny', calories: 490, protein: 28, carbs: 1, fat: 42 },
            { name: 'Kiełbasa śląska', category: 'Wędliny', calories: 280, protein: 14, fat: 25, carbs: 1.5 },
            { name: 'Kiełbasa żywiecka', category: 'Wędliny', calories: 325, protein: 18, carbs: 1, fat: 28 },
            { name: 'Polędwica sopocka', category: 'Wędliny', calories: 160, protein: 19, fat: 9, carbs: 1 },
            { name: 'Szynka gotowana', category: 'Wędliny', calories: 128, protein: 20, carbs: 1, fat: 5 },
            // Ryby
            { name: 'Dorsz', category: 'Ryby', calories: 82, protein: 17.8, carbs: 0, fat: 0.7 },
            { name: 'Halibut', category: 'Ryby', calories: 110, protein: 21, carbs: 0, fat: 2.5 },
            { name: 'Łosoś świeży', category: 'Ryby', calories: 208, protein: 20, fat: 13, carbs: 0 },
            { name: 'Makrela wędzona', category: 'Ryby', calories: 355, protein: 20.7, carbs: 0, fat: 30.5 },
            { name: 'Mintaj', category: 'Ryby', calories: 81, protein: 17.5, carbs: 0, fat: 1 },
            { name: 'Pstrąg tęczowy', category: 'Ryby', calories: 140, protein: 21, carbs: 0, fat: 6 },
            { name: 'Sardynki w oleju', category: 'Ryby', calories: 208, protein: 25, carbs: 0, fat: 11 },
            { name: 'Śledź w oleju', category: 'Ryby', calories: 300, protein: 16, carbs: 0, fat: 25 },
            { name: 'Tuńczyk w wodzie', category: 'Ryby', calories: 116, protein: 25.5, carbs: 0, fat: 0.8 },
            // Nabiał i Jaja
            { name: 'Jajko kurze', category: 'Nabiał i Jaja', calories: 155, protein: 12.6, carbs: 1.1, fat: 10.6, unit: 'szt', avgWeight: 55 },
            { name: 'Jogurt grecki', category: 'Nabiał i Jaja', calories: 97, protein: 10, carbs: 3.6, fat: 5 },
            { name: 'Jogurt naturalny', category: 'Nabiał i Jaja', calories: 61, protein: 4.3, fat: 3, carbs: 6.2 },
            { name: 'Kefir 2%', category: 'Nabiał i Jaja', calories: 51, protein: 3.4, fat: 2, carbs: 4.7 },
            { name: 'Mleko 3.2%', category: 'Nabiał i Jaja', calories: 61, protein: 3.2, fat: 3.2, carbs: 4.8 },
            { name: 'Ser mozzarella light', category: 'Nabiał i Jaja', calories: 171, protein: 25, carbs: 1, fat: 7 },
            { name: 'Ser żółty (Gouda)', category: 'Nabiał i Jaja', calories: 356, protein: 25, carbs: 2.2, fat: 27 },
            { name: 'Serek wiejski', category: 'Nabiał i Jaja', calories: 97, protein: 11, carbs: 2.7, fat: 4.3 },
            { name: 'Skyr naturalny', category: 'Nabiał i Jaja', calories: 63, protein: 12, carbs: 4, fat: 0.2 },
            { name: 'Śmietana 18%', category: 'Nabiał i Jaja', calories: 186, protein: 2.8, fat: 18, carbs: 3.7 },
            { name: 'Twaróg chudy', category: 'Nabiał i Jaja', calories: 98, protein: 19.8, carbs: 3.5, fat: 0.5 },
            { name: 'Twaróg półtłusty', category: 'Nabiał i Jaja', calories: 133, protein: 18.7, carbs: 3.7, fat: 5 },
            { name: 'Twaróg tłusty', category: 'Nabiał i Jaja', calories: 175, protein: 17, carbs: 3, fat: 11 },
            // Odżywki
            { name: 'Gainer', category: 'Odżywki', calories: 380, protein: 20, carbs: 70, fat: 2 },
            { name: 'Odżywka białkowa', category: 'Odżywki', calories: 380, protein: 80, carbs: 5, fat: 4 },
            // Produkty Zbożowe
            { name: 'Chleb biały (pszenny)', category: 'Produkty Zbożowe', calories: 265, protein: 9, carbs: 50, fat: 3.2 },
            { name: 'Chleb pełnoziarnisty', category: 'Produkty Zbożowe', calories: 250, protein: 13, carbs: 43, fat: 3 },
            { name: 'Chleb pszenny', category: 'Produkty Zbożowe', calories: 265, protein: 9, fat: 3.2, carbs: 49 },
            { name: 'Chleb żytni razowy', category: 'Produkty Zbożowe', calories: 259, protein: 8.5, fat: 3.3, carbs: 48 },
            { name: 'Kasza gryczana', category: 'Produkty Zbożowe', calories: 343, protein: 13.3, carbs: 71.5, fat: 3.4 },
            { name: 'Kasza jaglana', category: 'Produkty Zbożowe', calories: 378, protein: 11, carbs: 73, fat: 4.2 },
            { name: 'Komosa ryżowa (Quinoa)', category: 'Produkty Zbożowe', calories: 368, protein: 14.1, carbs: 64.2, fat: 6.1 },
            { name: 'Makaron jajeczny', category: 'Produkty Zbożowe', calories: 371, protein: 13, fat: 2.8, carbs: 74 },
            { name: 'Makaron pełnoziarnisty', category: 'Produkty Zbożowe', calories: 348, protein: 13.9, carbs: 73.3, fat: 2.8 },
            { name: 'Płatki owsiane', category: 'Produkty Zbożowe', calories: 389, protein: 16.9, carbs: 66.3, fat: 6.9 },
            { name: 'Ryż basmati', category: 'Produkty Zbożowe', calories: 349, protein: 9.7, carbs: 75, fat: 0.4 },
            { name: 'Ryż biały', category: 'Produkty Zbożowe', calories: 365, protein: 7.1, carbs: 79.9, fat: 0.7 },
            { name: 'Ryż brązowy', category: 'Produkty Zbożowe', calories: 370, protein: 7.9, carbs: 77.2, fat: 2.9 },
            // Rośliny strączkowe
            { name: 'Ciecierzyca (sucha)', category: 'Rośliny strączkowe', calories: 364, protein: 19, carbs: 61, fat: 6 },
            { name: 'Fasola czerwona (konserwowa)', category: 'Rośliny strączkowe', calories: 127, protein: 8.7, carbs: 22.8, fat: 0.5 },
            { name: 'Groch (łuskany, suchy)', category: 'Rośliny strączkowe', calories: 341, protein: 24.5, carbs: 60, fat: 1.2 },
            { name: 'Soczewica czerwona (sucha)', category: 'Rośliny strączkowe', calories: 353, protein: 25.8, carbs: 60, fat: 1.1 },
            // Warzywa i Owoce
            { name: 'Awokado', category: 'Warzywa i Owoce', calories: 160, protein: 2, fat: 15, carbs: 9 },
            { name: 'Banan', category: 'Warzywa i Owoce', calories: 89, protein: 1.1, fat: 0.3, carbs: 23 },
            { name: 'Bataty', category: 'Warzywa i Owoce', calories: 86, protein: 1.6, carbs: 20.1, fat: 0.1 },
            { name: 'Brokuł', category: 'Warzywa i Owoce', calories: 34, protein: 2.8, fat: 0.4, carbs: 7 },
            { name: 'Cebula', category: 'Warzywa i Owoce', calories: 40, protein: 1.1, fat: 0.1, carbs: 9 },
            { name: 'Jabłko', category: 'Warzywa i Owoce', calories: 52, protein: 0.3, fat: 0.2, carbs: 14 },
            { name: 'Marchew', category: 'Warzywa i Owoce', calories: 41, protein: 0.9, fat: 0.2, carbs: 10 },
            { name: 'Ogórek', category: 'Warzywa i Owoce', calories: 15, protein: 0.7, fat: 0.1, carbs: 3.6 },
            { name: 'Papryka czerwona', category: 'Warzywa i Owoce', calories: 31, protein: 1, fat: 0.3, carbs: 6 },
            { name: 'Pomarańcza', category: 'Warzywa i Owoce', calories: 47, protein: 0.9, fat: 0.1, carbs: 12 },
            { name: 'Pomidor', category: 'Warzywa i Owoce', calories: 18, protein: 0.9, fat: 0.2, carbs: 3.9 },
            { name: 'Sałata lodowa', category: 'Warzywa i Owoce', calories: 14, protein: 0.9, fat: 0.1, carbs: 3 },
            { name: 'Szpinak', category: 'Warzywa i Owoce', calories: 23, protein: 2.9, carbs: 3.6, fat: 0.4 },
            { name: 'Truskawki', category: 'Warzywa i Owoce', calories: 32, protein: 0.7, fat: 0.3, carbs: 8 },
            { name: 'Winogrona', category: 'Warzywa i Owoce', calories: 69, protein: 0.7, fat: 0.2, carbs: 18 },
            { name: 'Ziemniaki', category: 'Warzywa i Owoce', calories: 77, protein: 2, fat: 0.1, carbs: 17 },
            // Tłuszcze
            { name: 'Masło 82%', category: 'Tłuszcze', calories: 740, protein: 1, carbs: 1, fat: 82 },
            { name: 'Masło orzechowe', category: 'Tłuszcze', calories: 597, protein: 22.5, carbs: 22.3, fat: 51.1 },
            { name: 'Migdały', category: 'Tłuszcze', calories: 579, protein: 21.2, carbs: 21.6, fat: 49.9 },
            { name: 'Nasiona słonecznika', category: 'Tłuszcze', calories: 584, protein: 20.8, carbs: 20, fat: 51.5 },
            { name: 'Olej lniany', category: 'Tłuszcze', calories: 884, protein: 0, carbs: 0, fat: 100 },
            { name: 'Oliwa z oliwek', category: 'Tłuszcze', calories: 884, protein: 0, carbs: 0, fat: 100 },
            { name: 'Orzechy włoskie', category: 'Tłuszcze', calories: 654, protein: 15.2, carbs: 13.7, fat: 65.2 },
            { name: 'Pestki dyni', category: 'Tłuszcze', calories: 559, protein: 30.2, carbs: 10.7, fat: 49.1 },
        ];
        
        let foodProducts = [...initialFoodProducts];
        let customProducts = [];

        // --- ZMIENNE GLOBALNE ---
        let dietGoals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
        let dailyPlan = [];
        let currentlySelectedProduct = null;
        let sortedFoodProducts = [...foodProducts].sort((a, b) => a.name.localeCompare(b.name)); // <-- ZMIANA: Natychmiastowa inicjalizacja
        let activeMealIdForAdding = null; // <-- NOWA ZMIENNA
        let activeComposerInput = null; // <-- NOWA ZMIENNA: Śledzi, które pole w kompozytorze jest aktywne


        // --- ELEMENTY DOM ---
        const calculateBtn = document.getElementById('calculate-btn');
        const editDataBtn = document.getElementById('edit-data-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const addProductBtn = document.getElementById('add-product-btn');
        
        const productSearchInput = document.getElementById('product-search');
        const productSuggestionsContainer = document.getElementById('product-suggestions');
        
        const resultsSection = document.getElementById('results');
        const plannerSection = document.getElementById('diet-planner');
        const principlesSection = document.getElementById('key-principles');
        const supplementationSection = document.getElementById('supplementation');
        const hydrationSection = document.getElementById('hydration');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const clearDayBtn = document.getElementById('clear-day-btn');
        const addMealSeparatorBtn = document.getElementById('add-meal-separator-btn');
        
        const userNameInput = document.getElementById('user-name');
        const userNameDisplay = document.getElementById('user-name-display');
        const allDataInputs = [
            document.getElementById('user-name'),
            document.getElementById('gender'),
            document.getElementById('age'),
            document.getElementById('height'),
            document.getElementById('weight'),
            document.getElementById('activity'),
            document.getElementById('goal')
        ];

        // Elementy modali
        const openModalBtn = document.getElementById('open-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const customProductModal = document.getElementById('custom-product-modal');
        const customProductForm = document.getElementById('custom-product-form');

        const openComposerBtn = document.getElementById('open-composer-btn');
        const closeComposerBtn = document.getElementById('close-composer-btn');
        const mealComposerModal = document.getElementById('meal-composer-modal');
        const composerIngredientsContainer = document.getElementById('composer-ingredients-container');
        const composerSummaryDiv = document.getElementById('composer-summary');
        const saveComposedMealBtn = document.getElementById('save-composed-meal-btn');

        const showProductListBtn = document.getElementById('show-product-list-btn');
        const productListModal = document.getElementById('product-list-modal');
        const closeProductListBtn = document.getElementById('close-product-list-btn');
        const modalProductListContent = document.getElementById('modal-product-list-content');

        // --- FUNKCJE ---

        function getDailyPlanKey() {
            const today = new Date();
            return `dailyPlan_${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }
        
        function saveDailyPlan() {
            localStorage.setItem(getDailyPlanKey(), JSON.stringify(dailyPlan));
        }

        function loadDailyPlan() {
            const savedPlan = localStorage.getItem(getDailyPlanKey());
            if (savedPlan) {
                try {
                    dailyPlan = JSON.parse(savedPlan);
                } catch (e) {
                    console.error("Błąd parsowania dailyPlan z localStorage:", e);
                    dailyPlan = [];
                    localStorage.removeItem(getDailyPlanKey()); // Wyczyść uszkodzone dane
                }
            } else {
                dailyPlan = [];
            }
        }

        function clearDailyPlan() {
            dailyPlan = [];
            saveDailyPlan();
            renderMealList();
            updateSummary();
            showToast("Dzisiejszy plan został wyczyszczony.", 'success');
        }

        function addMealSeparator() {
            if (dailyPlan.length === 0 || dailyPlan[dailyPlan.length - 1].type !== 'separator') {
                 // ZMIANA: Oblicz numer posiłku i dodaj domyślną nazwę
                 const mealCount = dailyPlan.filter(item => item.type === 'separator').length + 1;
                 const separator = {
                    id: Date.now(),
                    type: 'separator',
                    name: `Posiłek ${mealCount}`
                };
                dailyPlan.push(separator);

                activeMealIdForAdding = separator.id; // <-- NOWA LINIA: Ustaw nowy posiłek jako aktywny

                saveDailyPlan();
                renderMealList();
            } else {
                showToast('Nowy posiłek został już rozpoczęty.');
            }
        }
        
        function clearUserData() {
            localStorage.removeItem('hypertrophyCalcUser');
            localStorage.removeItem(getDailyPlanKey());
            
            dailyPlan = [];
            dietGoals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            
            allDataInputs.forEach(input => {
                if(input.type === 'select-one') {
                     if(input.id === 'activity') input.value = '1.6';
                     else if(input.id === 'goal') input.value = '0.5';
                     else input.selectedIndex = 0;
                } else {
                    input.value = '';
                }
            });

            document.getElementById('user-data').classList.remove('hidden');
            document.getElementById('user-profile').classList.add('hidden');
            resultsSection.classList.add('hidden');
            plannerSection.classList.add('hidden');
            principlesSection.classList.add('hidden');
            supplementationSection.classList.add('hidden');
            hydrationSection.classList.add('hidden');
            
            renderMealList();
            showToast("Wszystkie dane zostały wyczyszczone.", 'success');
        }

        /**
         * Zapisuje dane użytkownika w localStorage.
         */
        function saveUserData() {
            const userData = {
                name: document.getElementById('user-name').value,
                gender: document.getElementById('gender').value,
                age: document.getElementById('age').value,
                height: document.getElementById('height').value,
                weight: document.getElementById('weight').value,
                activity: document.getElementById('activity').value,
                goal: document.getElementById('goal').value,
            };
            localStorage.setItem('hypertrophyCalcUser', JSON.stringify(userData));
        }

        /**
         * Wczytuje dane użytkownika z localStorage i aktualizuje UI.
         */
        function loadUserData() {
            const savedData = localStorage.getItem('hypertrophyCalcUser');
            if (savedData) {
                const userData = JSON.parse(savedData);
                userNameInput.value = userData.name || '';
                document.getElementById('gender').value = userData.gender || 'male';
                document.getElementById('age').value = userData.age || '';
                document.getElementById('height').value = userData.height || '';
                document.getElementById('weight').value = userData.weight || '';
                document.getElementById('activity').value = userData.activity || '1.6';
                document.getElementById('goal').value = userData.goal || '0.5';

                if(userData.name && userData.age && userData.height && userData.weight) {
                    calculateNeeds();
                }
            }
        }

        /**
         * Pokazuje powiadomienie (toast).
         */
        function showToast(message, type = 'error') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-emerald-500';
            toast.className = `toast p-4 rounded-lg shadow-lg text-white font-medium ${bgColor}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        /**
         * Oblicza zapotrzebowanie kaloryczne i makroskładniki na podstawie danych użytkownika.
         */
        function calculateNeeds() {
            const userName = userNameInput.value.trim();
            const gender = document.getElementById('gender').value;
            const age = parseFloat(document.getElementById('age').value);
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const activityFactor = parseFloat(document.getElementById('activity').value);
            const goalFactor = parseFloat(document.getElementById('goal').value);
            
            if (!userName) {
                showToast("Proszę podać swoje imię.");
                return;
            }
            if (!age || age <= 0) {
                showToast("Proszę podać prawidłowy wiek.");
                return;
            }
            if (!height || height <= 0) {
                showToast("Proszę podać prawidłowy wzrost.");
                return;
            }
            if (!weight || weight <= 0) {
                showToast("Proszę podać prawidłową wagę.");
                return;
            }

            saveUserData();

            // Krok 1: Obliczanie BMR wzorem Mifflin-St Jeor
            let bmr;
            if (gender === 'male') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else { // female
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
            
            const maintenanceCalories = bmr * activityFactor;

            // Krok 2: Ustalenie nadwyżki kalorycznej
            const weeklyGainKg = weight * (goalFactor / 100);
            const dailySurplus = (weeklyGainKg * 7700) / 7; 
            
            const targetCalories = maintenanceCalories + dailySurplus;

            // Krok 3: Obliczenie białka (2.0 g/kg)
            const proteinGrams = weight * 2.0;
            const proteinCalories = proteinGrams * 4;

            // Krok 4: Obliczenie tłuszczu (1.0 g/kg)
            const fatGrams = weight * 1.0;
            const fatCalories = fatGrams * 9;

            // Krok 5: Obliczenie węglowodanów z pozostałych kalorii
            const remainingCalories = targetCalories - proteinCalories - fatCalories;
            const carbsGrams = remainingCalories / 4;
            
            dietGoals = {
                calories: Math.round(targetCalories),
                protein: Math.round(proteinGrams),
                carbs: Math.round(carbsGrams),
                fat: Math.round(fatGrams)
            };

            displayResults();
            updateSummary();
            
            document.getElementById('user-data').classList.add('hidden');
            document.getElementById('user-profile').classList.remove('hidden');
            userNameDisplay.textContent = userName;

            resultsSection.classList.remove('hidden');
            plannerSection.classList.remove('hidden');
            principlesSection.classList.remove('hidden');
            supplementationSection.classList.remove('hidden');
            hydrationSection.classList.remove('hidden');
        }

        /**
         * Wyświetla obliczone wyniki w interfejsie.
         */
        function displayResults() {
            document.getElementById('total-calories').textContent = `${dietGoals.calories} kcal`;
            document.getElementById('protein-grams').textContent = `${dietGoals.protein} g`;
            document.getElementById('carbs-grams').textContent = `${dietGoals.carbs} g`;
            document.getElementById('fat-grams').textContent = `${dietGoals.fat} g`;
        }

        /**
         * Dodaje wybrany produkt do dziennego planu posiłków.
         */
        function addProductToPlan() {
            const amount = parseFloat(document.getElementById('product-amount').value);
            
            if (!currentlySelectedProduct || productSearchInput.value !== currentlySelectedProduct.name) {
                showToast("Wybierz produkt z listy sugestii.");
                return;
            }
            if (!amount || amount <= 0) {
                showToast("Podaj prawidłową ilość.");
                return;
            }
            
            const hasMeals = dailyPlan.some(item => item.type === 'separator');
            if (!hasMeals) {
                addMealSeparator(); // Ta funkcja ustawi teraz activeMealIdForAdding
            }

            const product = currentlySelectedProduct;
            let calculatedAmountInGrams = amount;
            let displayUnit = 'g';
            let factor; // <-- ZMIANA: Zadeklaruj 'factor' wyżej

            if (product.isComposed) { // <-- NOWA LOGIKA
                displayUnit = 'porcji';
                factor = amount; // Ilość (np. 1.5) to prosty mnożnik
            } else if (product.unit === 'szt' && product.avgWeight) {
                calculatedAmountInGrams = amount * product.avgWeight;
                displayUnit = 'szt';
                factor = calculatedAmountInGrams / 100;
            } else {
                // To jest zwykły produkt w gramach
                factor = calculatedAmountInGrams / 100;
            }
            
            const mealItem = {
                id: Date.now(),
                type: 'product',
                name: product.name,
                amount: amount,
                displayUnit: displayUnit, // <-- 'displayUnit' będzie teraz poprawny
                calories: product.calories * factor,
                protein: product.protein * factor,
                carbs: product.carbs * factor,
                fat: product.fat * factor
            };
            
            // --- POPRAWIONA LOGIKA DODAWANIA ---
            let mealToAddToId = activeMealIdForAdding;

            // Jeśli żaden posiłek nie jest aktywny (np. po wyczyszczeniu), wybierz ostatni
            if (!mealToAddToId) {
                const lastSeparator = dailyPlan.filter(item => item.type === 'separator').pop();
                if (lastSeparator) {
                    mealToAddToId = lastSeparator.id;
                    activeMealIdForAdding = mealToAddToId; // Ustaw go jako aktywny
                }
            }

            if (mealToAddToId) {
                const separatorIndex = dailyPlan.findIndex(item => item.id === mealToAddToId);
                
                if (separatorIndex !== -1) {
                    // Znajdź indeks NASTĘPNEGO separatora
                    let nextSeparatorIndex = dailyPlan.findIndex((item, index) => index > separatorIndex && item.type === 'separator');
                    
                    if (nextSeparatorIndex === -1) {
                        // To jest ostatni posiłek, więc dodaj na koniec
                        dailyPlan.push(mealItem);
                    } else {
                        // To posiłek w środku, wstaw produkt tuż przed następnym posiłkiem
                        dailyPlan.splice(nextSeparatorIndex, 0, mealItem);
                    }
                } else {
                    // Fallback: Aktywny ID był zły, po prostu dodaj na koniec
                    dailyPlan.push(mealItem);
                }
            } else {
                // Absolutny fallback (nie powinno się zdarzyć po `addMealSeparator`), dodaj na koniec
                dailyPlan.push(mealItem);
            }
            // --- KONIEC POPRAWIONEJ LOGIKI ---
            
            saveDailyPlan();
            renderMealList();
            updateSummary();
            
            productSearchInput.value = '';
            currentlySelectedProduct = null;
            document.getElementById('product-amount').value = '';
            document.getElementById('product-amount').placeholder = 'Ilość (g)';
        }

        function calculateMealSummary(products) {
            return products.reduce((acc, item) => {
                acc.calories += item.calories;
                acc.protein += item.protein;
                acc.carbs += item.carbs;
                acc.fat += item.fat;
                return acc;
            }, { calories: 0, protein: 0, carbs: 0, fat: 0 });
        }
        
        /**
         * Renderuje listę posiłków w interfejsie.
         */
        function renderMealList() {
            const mealListDiv = document.getElementById('meal-list');
            mealListDiv.innerHTML = '';

            if (dailyPlan.length === 0) {
                mealListDiv.innerHTML = '<p class="text-center text-gray-500">Twoja lista posiłków jest pusta.</p>';
                exportPdfBtn.disabled = true;
                return;
            }
            
            exportPdfBtn.disabled = false;
            
            const meals = [];
            let currentMeal = null;

            dailyPlan.forEach(item => {
                if (item.type === 'separator') {
                    if (currentMeal) {
                        meals.push(currentMeal);
                    }
                    currentMeal = { separator: item, products: [] };
                } else if (item.type === 'product' && currentMeal) {
                    currentMeal.products.push(item);
                }
            });

            if (currentMeal) {
                meals.push(currentMeal);
            }

            meals.forEach((meal, index) => {
                const mealContainer = document.createElement('div');
                mealContainer.className = 'bg-gray-700/50 rounded-lg overflow-hidden fade-in';
                mealContainer.dataset.mealContainerId = meal.separator.id; // <-- NOWY ATRYBUT

                // --- NOWA LINIA: Wizualne podświetlenie aktywnego posiłku ---
                if (meal.separator.id === activeMealIdForAdding) {
                    mealContainer.style.boxShadow = '0 0 0 2px #22D3EE'; // Kolor cyan-400 z Tailwind
                }

                const header = document.createElement('div');
                header.className = 'meal-header flex justify-between items-center p-4 cursor-pointer hover:bg-gray-700 transition-colors';
                header.dataset.targetId = `meal-content-${meal.separator.id}`;

                const mealSummary = calculateMealSummary(meal.products);

                // ZMIANA: Użyj zapisanej nazwy posiłku lub domyślnej, a następnie stwórz pole input
                const mealName = meal.separator.name || `Posiłek ${index + 1}`;

                header.innerHTML = `
                    <div class="flex items-center gap-3 flex-grow mr-2" style="min-width: 0;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="chevron h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                        <input type="text" value="${mealName}" data-id="${meal.separator.id}" class="meal-name-input font-bold text-green-400 bg-transparent border-0 focus:ring-1 focus:ring-green-500 focus:outline-none w-full p-1 rounded-md" placeholder="Nazwa posiłku...">
                    </div>
                    <div class="flex items-center gap-4 flex-shrink-0">
                        <p class="text-xs text-gray-400 hidden sm:block">
                            ${mealSummary.calories.toFixed(0)} kcal | B: ${mealSummary.protein.toFixed(1)}g | W: ${mealSummary.carbs.toFixed(1)}g | T: ${mealSummary.fat.toFixed(1)}g
                        </p>
                        <button data-id="${meal.separator.id}" class="remove-meal-btn text-red-400 hover:text-red-500 z-10 p-1">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;

                const content = document.createElement('div');
                content.id = `meal-content-${meal.separator.id}`;
                content.className = 'meal-content space-y-2 px-4 pb-4';

                if (meal.products.length === 0) {
                    content.innerHTML = `<p class="text-sm text-center text-gray-500 py-2">Ten posiłek jest pusty.</p>`;
                } else {
                    meal.products.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'bg-gray-700 p-3 rounded-lg flex items-center justify-between';
                        
                        // ZMIANA BŁĘDU #1: Używamy item.amount dla wartości, ale zerujemy makra, jeśli amount to 0
                        const displayAmount = item.amount === 0 ? '' : item.amount;
                        const displayCalories = item.amount === 0 ? 0 : item.calories;
                        const displayProtein = item.amount === 0 ? 0 : item.protein;
                        const displayCarbs = item.amount === 0 ? 0 : item.carbs;
                        const displayFat = item.amount === 0 ? 0 : item.fat;

                        itemDiv.innerHTML = `
                            <div class="flex-grow">
                                <p class="font-semibold text-white">${item.name}</p>
                                <p class="text-xs text-gray-400 macros-display" data-id="${item.id}">
                                    Kcal: ${displayCalories.toFixed(0)} | B: ${displayProtein.toFixed(1)}g | W: ${displayCarbs.toFixed(1)}g | T: ${displayFat.toFixed(1)}g
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" value="${displayAmount}" data-id="${item.id}" class="edit-amount-input w-20 bg-gray-800 border border-gray-600 rounded-md p-1 text-center text-white focus:ring-1 focus:ring-cyan-500 focus:outline-none">
                                <span class="text-gray-400 text-sm">${item.displayUnit || 'g'}</span>
                                <button data-id="${item.id}" class="remove-item-btn text-red-400 hover:text-red-500 text-2xl leading-none">&times;</button>
                            </div>
                        `;
                        content.appendChild(itemDiv);
                    });
                }
                
                const isCollapsedByDefault = index < meals.length - 1;
                if (isCollapsedByDefault) {
                    header.classList.add('collapsed');
                    content.classList.add('collapsed');
                }

                mealContainer.appendChild(header);
                mealContainer.appendChild(content);
                mealListDiv.appendChild(mealContainer);
            });
        }
        
        /**
         * Aktualizuje podsumowanie i paski postępu.
         */
        function updateSummary() {
            const totals = dailyPlan
                .filter(item => item.type === 'product')
                .reduce((acc, item) => {
                    acc.calories += item.calories;
                    acc.protein += item.protein;
                    acc.carbs += item.carbs;
                    acc.fat += item.fat;
                    return acc;
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });

            const updateField = (name, total, goal, unit) => {
                const currentEl = document.getElementById(`current-${name}`);
                const progressEl = document.getElementById(`${name}-progress`);
                if (!currentEl || !progressEl) return;
                
                currentEl.textContent = `${total.toFixed(0)} / ${goal} ${unit}`;
                const percentage = goal > 0 ? (total / goal) * 100 : 0;
                progressEl.style.width = `${Math.min(percentage, 100)}%`;
            };

            updateField('calories', totals.calories, dietGoals.calories, 'kcal');
            updateField('protein', totals.protein, dietGoals.protein, 'g');
            updateField('carbs', totals.carbs, dietGoals.carbs, 'g');
            updateField('fat', totals.fat, dietGoals.fat, 'g');
        }

        /**
         * Obsługuje usuwanie produktu z listy i zwijanie posiłków.
         */
        function handleMealListClick(e) {
            // Zapobiegaj zwijaniu/rozwijaniu posiłku, gdy kliknięto w pole tekstowe
            if (e.target.classList.contains('meal-name-input')) {
                return;
            }

            const removeItemBtn = e.target.closest('.remove-item-btn');
            if (removeItemBtn) {
                const itemId = parseInt(removeItemBtn.dataset.id);
                dailyPlan = dailyPlan.filter(item => item.id !== itemId);
                saveDailyPlan();
                renderMealList(); // Musimy przerenderować, aby zaktualizować podsumowanie posiłku
                updateSummary();
                return;
            }

            const removeMealBtn = e.target.closest('.remove-meal-btn');
            if(removeMealBtn) {
                const separatorId = parseInt(removeMealBtn.dataset.id);
                const separatorIndex = dailyPlan.findIndex(item => item.id === separatorId);
                
                if (separatorIndex !== -1) {
                    let nextSeparatorIndex = dailyPlan.findIndex((item, index) => index > separatorIndex && item.type === 'separator');
                    if (nextSeparatorIndex === -1) {
                        nextSeparatorIndex = dailyPlan.length;
                    }
                    dailyPlan.splice(separatorIndex, nextSeparatorIndex - separatorIndex);
                    
                    // ZMIANA: Jeśli usunięto aktywny posiłek, wyczyść go
                    if (activeMealIdForAdding === separatorId) {
                        activeMealIdForAdding = null;
                        // Opcjonalnie: ustaw na ostatni posiłek, jeśli jakiś został
                        const lastSeparator = dailyPlan.filter(item => item.type === 'separator').pop();
                        if (lastSeparator) {
                            activeMealIdForAdding = lastSeparator.id;
                        }
                    }

                    saveDailyPlan();
                    renderMealList();
                    updateSummary();
                }
                return;
            }

            const mealHeader = e.target.closest('.meal-header');
            if(mealHeader) {
                const contentId = mealHeader.dataset.targetId;
                const content = document.getElementById(contentId);
                if (content) {
                    
                    // --- NOWA LOGIKA: Ustawianie aktywnego posiłku ---
                    const mealId = parseInt(mealHeader.querySelector('.meal-name-input').dataset.id, 10);
                    
                    if (content.classList.contains('collapsed')) {
                        // Jeśli jest zwinięty, to znaczy, że się OTWIERA
                        activeMealIdForAdding = mealId;
                    } else {
                        // Jeśli jest rozwinięty, to znaczy, że się ZAMYKA
                        // Nie robimy nic, ostatnio otwarty pozostaje aktywny
                    }

                    // Ręczna aktualizacja podświetlenia
                    document.querySelectorAll('[data-meal-container-id]').forEach(el => {
                        el.style.boxShadow = 'none'; // Wyczyść wszystkie
                    });
                    if (activeMealIdForAdding) {
                        const activeContainer = document.querySelector(`[data-meal-container-id="${activeMealIdForAdding}"]`);
                        if (activeContainer) {
                            activeContainer.style.boxShadow = '0 0 0 2px #22D3EE';
                        }
                    }
                    // --- KONIEC NOWEJ LOGIKI ---

                    mealHeader.classList.toggle('collapsed');
                    content.classList.toggle('collapsed');
                }
            }
        }

        // NOWA FUNKCJA: Obsługuje zmianę nazwy posiłku
        function handleMealNameChange(e) {
            if (!e.target.classList.contains('meal-name-input')) return;

            const separatorId = parseInt(e.target.dataset.id);
            const newName = e.target.value;

            const itemIndex = dailyPlan.findIndex(item => item.id === separatorId);
            if (itemIndex !== -1) {
                dailyPlan[itemIndex].name = newName;
                saveDailyPlan();
            }
        }

        // **** START POPRAWKI BŁĘDU #1 ****
        function handleAmountChange(e) {
            if (!e.target.classList.contains('edit-amount-input')) return;

            const itemId = parseInt(e.target.dataset.id);
            const newAmount = parseFloat(e.target.value); // Zwróci NaN dla ""

            const itemIndex = dailyPlan.findIndex(item => item.id === itemId);
            
            if (itemIndex === -1) {
                 return; // Produkt nie istnieje, wyjdź
            }
            
            if (isNaN(newAmount) || newAmount < 0) {
                // Puste pole (NaN) lub ujemna wartość. Zerujemy makra.
                const itemToUpdate = dailyPlan[itemIndex];
                
                itemToUpdate.amount = 0; // Ustawiamy na 0 dla spójności
                itemToUpdate.calories = 0;
                itemToUpdate.protein = 0;
                itemToUpdate.carbs = 0;
                itemToUpdate.fat = 0;

                // Zaktualizuj wyświetlanie makr dla tego produktu
                const macrosDisplay = document.querySelector(`.macros-display[data-id="${itemId}"]`);
                if (macrosDisplay) {
                    macrosDisplay.innerHTML = `Kcal: 0 | B: 0.0g | W: 0.0g | T: 0.0g`;
                }

                saveDailyPlan();
                updateSummary();
                updateMealHeaderSummary(e.target); // Zaktualizuj nagłówek posiłku
                
                return; // Zakończ
            }

            // Standardowa logika dla poprawnych wartości
            const itemToUpdate = dailyPlan[itemIndex];
            const originalProduct = foodProducts.find(p => p.name === itemToUpdate.name);

            if (!originalProduct) return; 

            itemToUpdate.amount = newAmount;

            let factor; 

            if (originalProduct.isComposed) { 
                factor = newAmount; 
            } else {
                let calculatedAmountInGrams = newAmount;
                if (originalProduct.unit === 'szt' && originalProduct.avgWeight) {
                    calculatedAmountInGrams = newAmount * originalProduct.avgWeight;
                }
                factor = calculatedAmountInGrams / 100;
            }

            itemToUpdate.calories = originalProduct.calories * factor;
            itemToUpdate.protein = originalProduct.protein * factor;
            itemToUpdate.carbs = originalProduct.carbs * factor;
            itemToUpdate.fat = originalProduct.fat * factor;

            const macrosDisplay = document.querySelector(`.macros-display[data-id="${itemId}"]`);
            if (macrosDisplay) {
                macrosDisplay.innerHTML = `Kcal: ${itemToUpdate.calories.toFixed(0)} | B: ${itemToUpdate.protein.toFixed(1)}g | W: ${itemToUpdate.carbs.toFixed(1)}g | T: ${itemToUpdate.fat.toFixed(1)}g`;
            }

            saveDailyPlan();
            updateSummary();
            
            // Wywołanie nowej funkcji pomocniczej
            updateMealHeaderSummary(e.target);
        }

        /**
         * NOWA FUNKCJA POMOCNICZA (dla Błędu #1): Aktualizuje podsumowanie makro w nagłówku posiłku.
         * @param {HTMLElement} targetElement - Element (zazwyczaj input), który wywołał zmianę.
         */
        function updateMealHeaderSummary(targetElement) {
            const mealContainer = targetElement.closest('[data-meal-container-id]'); // Znajdź główny kontener posiłku
            if (mealContainer) {
                const mealHeader = mealContainer.querySelector('.meal-header');
                if (mealHeader) {
                    // Znajdź ID separatora z nagłówka
                    const separatorId = parseInt(mealHeader.querySelector('.remove-meal-btn').dataset.id, 10);
                    const separatorIndex = dailyPlan.findIndex(item => item.id === separatorId);
                    
                    if (separatorIndex !== -1) {
                         let nextSeparatorIndex = dailyPlan.findIndex((item, index) => index > separatorIndex && item.type === 'separator');
                         if (nextSeparatorIndex === -1) {
                             nextSeparatorIndex = dailyPlan.length;
                         }
                         // Mamy zakres [separatorIndex + 1, nextSeparatorIndex)
                         const mealProducts = dailyPlan.slice(separatorIndex + 1, nextSeparatorIndex).filter(item => item.type === 'product');
                         const summary = calculateMealSummary(mealProducts);
                         
                         const summaryEl = mealHeader.querySelector('.text-xs');
                         if (summaryEl) {
                             summaryEl.innerHTML = `${summary.calories.toFixed(0)} kcal | B: ${summary.protein.toFixed(1)}g | W: ${summary.carbs.toFixed(1)}g | T: ${summary.fat.toFixed(1)}g`;
                         }
                    }
                }
            }
        }
        // **** KONIEC POPRAWKI BŁĘDU #1 ****


        /**
         * Obsługuje działanie akordeonu.
         */
        function handleAccordionClick(e) {
            const button = e.target.closest('.accordion-btn');
            if (!button) return;

            const content = button.nextElementSibling;
            const icon = button.querySelector('svg');

            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                if(icon) icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                if(icon) icon.style.transform = 'rotate(180deg)';
            }
        }

        /**
         * Zapisuje własne produkty w localStorage.
         */
        function saveCustomProducts() {
            localStorage.setItem('customDietProducts', JSON.stringify(customProducts));
            updateSortedProducts();
        }

        /**
         * Wczytuje własne produkty z localStorage.
         */
        function loadCustomProducts() {
            try {
                const savedProducts = localStorage.getItem('customDietProducts');
                if (savedProducts) {
                    try {
                        customProducts = JSON.parse(savedProducts);
                        if (!Array.isArray(customProducts)) {
                            customProducts = [];
                            throw new Error("Custom products not an array");
                        }
                        
                        // --- NOWA LOGIKA MIGRACJI (Migracja 1 - pozostaje) ---
                        let needsSave = false;
                        customProducts.forEach(product => {
                            if (product.category === 'Własne produkty') {
                                product.category = 'Posiłki skomponowane';
                                needsSave = true;
                            }
                        });

                        // **** START POPRAWKI BŁĘDU #2 ****
                        // USUNIĘTO BLOK "NOWA LOGIKA MIGRACJI 2 (Czyszczenie duplikatów)"
                        // **** KONIEC POPRAWKI BŁĘDU #2 ****


                        if (needsSave) {
                            // Zapisz zmiany (tylko z migracji 1) z powrotem do localStorage
                            localStorage.setItem('customDietProducts', JSON.stringify(customProducts));
                        }
                        // --- KONIEC LOGIKI MIGRACJI ---

                    } catch (e) {
                        console.error("Błąd parsowania customDietProducts z localStorage:", e);
                        customProducts = [];
                        localStorage.removeItem('customDietProducts'); // Wyczyść uszkodzone dane
                    }
                } else {
                     customProducts = []; // Upewnij się, że jest pusta
                }
            } catch (e) {
                console.error("Ogólny błąd w loadCustomProducts:", e);
                customProducts = []; // Pełen reset
            } finally {
                updateSortedProducts(); // Zawsze uruchamiaj aktualizację
            }
        }

        function updateSortedProducts() {
            // Ta linia jest kluczowa: zawsze odbudowuj 'foodProducts'
            // z 'initialFoodProducts' i 'customProducts'
            foodProducts = [...initialFoodProducts, ...customProducts];
            sortedFoodProducts = [...foodProducts].sort((a, b) => a.name.localeCompare(b.name));
        }
        
        // ZMIANA START: Nowa funkcja do wypełniania listy kategorii
        /**
         * Wypełnia listę rozwijaną kategoriami produktów.
         */
        function populateCategoryDropdown() {
            const categorySelect = document.getElementById('new-product-category');
            const categories = [...new Set(foodProducts.map(p => p.category))].filter(c => c !== 'Własne produkty' && c !== 'Posiłki skomponowane'); // <-- ZMIANA
            
            categorySelect.innerHTML = ''; // Wyczyść istniejące opcje

            categories.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });

            // Dodaj opcję do stworzenia nowej kategorii
            const newCategoryOption = document.createElement('option');
            newCategoryOption.value = '__new__';
            newCategoryOption.textContent = '-- Dodaj nową kategorię --';
            categorySelect.appendChild(newCategoryOption);
        }
        // ZMIANA KONIEC

        /**
         * Obsługuje formularz dodawania nowego produktu.
         */
        function handleNewProductSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('new-product-name').value.trim();
            const protein = parseFloat(document.getElementById('new-product-protein').value);
            const carbs = parseFloat(document.getElementById('new-product-carbs').value);
            const fat = parseFloat(document.getElementById('new-product-fat').value);

            // ZMIANA START: Pobieranie kategorii z formularza
            const categorySelect = document.getElementById('new-product-category');
            let category = categorySelect.value;

            if (category === '__new__') {
                const newCategoryInput = document.getElementById('new-product-new-category');
                category = newCategoryInput.value.trim();
                if (!category) {
                    showToast('Podaj nazwę nowej kategorii.');
                    return;
                }
            }
            // ZMIANA KONIEC

            if (!name || isNaN(protein) || isNaN(carbs) || isNaN(fat) || protein < 0 || carbs < 0 || fat < 0) {
                showToast('Wypełnij wszystkie pola poprawnymi, dodatnimi wartościami.');
                return;
            }

            if (foodProducts.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                showToast('Produkt o tej nazwie już istnieje.');
                return;
            }

            const calories = (protein * 4) + (carbs * 4) + (fat * 9);

            const newProduct = {
                name: name,
                category: category, // ZMIANA: Użycie wybranej kategorii
                calories: Math.round(calories),
                protein: protein,
                carbs: carbs,
                fat: fat
            };

            customProducts.push(newProduct);
            // ----------------------------------------------------
            // foodProducts.push(newProduct); // <--- TO BYŁ BŁĄD. USUNIĘTO.
            // ----------------------------------------------------
            saveCustomProducts();
            
            customProductForm.reset();
            document.getElementById('new-category-wrapper').classList.add('hidden');
            customProductModal.classList.add('hidden');
            showToast('Produkt został dodany!', 'success');
        }


        /**
         * Funkcje dla nowego kalkulatora komponowania posiłku
         */

        function createIngredientRow() {
            const row = document.createElement('div');
            row.className = 'flex gap-2 items-center composer-row'; // Usunięto 'relative'
            
            // 1. Stwórz wrapper dla pola wyszukiwania (ale bez sugestii)
            const searchWrapper = document.createElement('div');
            searchWrapper.className = 'relative flex-grow';

            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.readOnly = true; // <-- NOWA LINIA: Pole jest tylko do odczytu, działa jak przycisk
            // Zmieniono 'flex-grow' na 'w-full' ponieważ jest teraz w wrapperze flex-grow
            searchInput.className = 'composer-search-input w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-sm text-white focus:ring-2 focus:ring-emerald-500 focus:outline-none cursor-pointer hover:bg-gray-600 transition-colors'; // <-- DODANO: cursor-pointer i hover
            searchInput.placeholder = 'Kliknij, aby wybrać składnik...'; // <-- ZMIANA: Lepszy placeholder
            searchInput.autocomplete = 'off';

            // USUNIĘTO: suggestionsContainer - nie jest już potrzebny

            const amountInput = document.createElement('input');
            amountInput.type = 'number';
            amountInput.className = 'w-24 bg-gray-700 border border-gray-600 rounded-lg p-2 text-sm text-white focus:ring-2 focus:ring-emerald-500 focus:outline-none';
            amountInput.placeholder = 'Ilość (g)';

            // 2. Dodaj searchInput do wrappera
            searchWrapper.appendChild(searchInput);
            
            // 3. Dodaj wrapper i amountInput do głównego wiersza
            row.appendChild(searchWrapper);
            row.appendChild(amountInput);

            // ZMIANA: Z 'input' na 'click', aby otworzyć modal
            searchInput.addEventListener('click', (e) => {
                activeComposerInput = e.target; // Ustaw to pole jako aktywne
                populateProductListModal(); // Wypełnij modal
                productListModal.classList.remove('hidden'); // Otwórz modal
            });
            amountInput.addEventListener('input', updateComposerSummary);

            return row;
        }

        // USUNIĘTO: funkcja showComposerSuggestions - nie jest już potrzebna

        function initializeComposer(productToEdit = null) {
            composerIngredientsContainer.innerHTML = '';
            activeComposerInput = null;
            
            // Wyczyść pola formularza
            const mealNameInput = document.getElementById('composer-meal-name');
            const originalNameInput = document.getElementById('composer-original-name');
            mealNameInput.value = '';
            originalNameInput.value = '';

            let ingredientCount = 0;

            if (productToEdit && productToEdit.isComposed && productToEdit.ingredients) {
                // Tryb edycji: Wypełnij formularz istniejącymi danymi
                mealNameInput.value = productToEdit.name;
                originalNameInput.value = productToEdit.name;

                productToEdit.ingredients.forEach(ing => {
                    const row = createIngredientRow();
                    const searchInput = row.querySelector('.composer-search-input');
                    const amountInput = row.querySelector('input[type="number"]');
                    
                    const product = foodProducts.find(p => p.name === ing.name);
                    
                    if (product) {
                        searchInput.value = ing.name;
                        searchInput.dataset.selectedProduct = JSON.stringify(product);
                        amountInput.value = ing.amount;
                        composerIngredientsContainer.appendChild(row);
                        ingredientCount++;
                    }
                });
            }

            // Zawsze dodawaj 5 pustych wierszy (lub mniej, jeśli już coś jest)
            const rowsToAdd = Math.max(5, ingredientCount + 5); // Zawsze miej 5 pustych
            for (let i = ingredientCount; i < rowsToAdd; i++) {
                composerIngredientsContainer.appendChild(createIngredientRow());
            }
            
            updateComposerSummary();
        }

        function updateComposerSummary() {
            const rows = document.querySelectorAll('.composer-row');
            let total = { calories: 0, protein: 0, carbs: 0, fat: 0 };

            rows.forEach(row => {
                const searchInput = row.querySelector('.composer-search-input');
                const amountInput = row.querySelector('input[type="number"]');
                const amount = parseFloat(amountInput.value);
                const productJSON = searchInput.dataset.selectedProduct;

                if (productJSON && searchInput.value && amount > 0) {
                    const product = JSON.parse(productJSON);
                    if (product && product.name === searchInput.value) {
                         const factor = amount / 100;
                        total.calories += product.calories * factor;
                        total.protein += product.protein * factor;
                        total.carbs += product.carbs * factor;
                        total.fat += product.fat * factor;
                    }
                }
            });

            composerSummaryDiv.innerHTML = `
                <div class="flex justify-between"><span>Kalorie:</span><span class="font-bold">${total.calories.toFixed(0)} kcal</span></div>
                <div class="flex justify-between"><span>Białko:</span><span class="font-bold">${total.protein.toFixed(1)} g</span></div>
                <div class="flex justify-between"><span>Węglowodany:</span><span class="font-bold">${total.carbs.toFixed(1)} g</span></div>
                <div class="flex justify-between"><span>Tłuszcze:</span><span class="font-bold">${total.fat.toFixed(1)} g</span></div>
            `;
        }
        
        async function exportToPDF() {
            if (dailyPlan.length === 0) {
                showToast('Dodaj przynajmniej jeden produkt do planu, aby go wyeksportować.');
                return;
            }

            const originalBtnText = exportPdfBtn.textContent;
            exportPdfBtn.disabled = true;
            exportPdfBtn.textContent = 'Generowanie PDF...';

            const printableArea = document.createElement('div');
            printableArea.style.cssText = 'position: absolute; left: -9999px; width: 800px; padding: 40px; background-color: #ffffff; color: #111827; font-family: "Roboto", sans-serif;';
            
            const userName = document.getElementById('user-name').value || 'Użytkownik';
            const today = new Date().toLocaleDateString('pl-PL');
            const totals = dailyPlan
                .filter(item => item.type !== 'separator')
                .reduce((acc, item) => {
                    acc.calories += item.calories;
                    acc.protein += item.protein;
                    acc.carbs += item.carbs;
                    acc.fat += item.fat;
                    return acc;
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });
            
            let mealCounter = 0;
            let printableHTML = `
                <div style="text-align: center; border-bottom: 2px solid #D1D5DB; padding-bottom: 20px; margin-bottom: 30px;">
                    <h1 style="font-size: 2.2rem; font-weight: bold; color: #1F2937;">PLAN ŻYWIENIOWY</h1>
                    <p style="font-size: 1.1rem; color: #6B7280;">Dla: ${userName} | Data: ${today}</p>
                </div>
                
                <div style="background-color: #F9FAFB; border: 1px solid #E5E7EB; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: #1F2937; margin-bottom: 15px; text-align: center;">CELE MAKROSKŁADNIKÓW</h2>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 1.1rem; color: #111827;">
                        <p><strong>Kalorie:</strong> ${dietGoals.calories} kcal</p>
                        <p><strong>Białko:</strong> ${dietGoals.protein} g</p>
                        <p><strong>Węglowodany:</strong> ${dietGoals.carbs} g</p>
                        <p><strong>Tłuszcze:</strong> ${dietGoals.fat} g</p>
                    </div>
                </div>

                <div>
                    <h2 style="font-size: 1.5rem; font-weight: bold; color: #1F2937; margin-bottom: 15px; border-bottom: 1px solid #D1D5DB; padding-bottom: 10px;">PRODUKTY W DIECIE</h2>
                    ${dailyPlan.map(item => {
                        if (item.type === 'separator') {
                            mealCounter++;
                            // ZMIANA: Użyj niestandardowej nazwy posiłku
                            const mealName = item.name || `Posiłek ${mealCounter}`;
                            return `<h3 style="font-size: 1.2rem; font-weight: bold; color: #374151; margin-top: 20px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #E5E7EB;">${mealName}</h3>`;
                        }
                         const displayAmount = `${item.amount} ${item.displayUnit || 'g'}`;
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #E5E7EB;">
                            <div>
                                <p style="font-weight: bold; font-size: 1.1rem;">${item.name} - ${displayAmount}</p>
                                <p style="font-size: 0.9rem; color: #6B7280;">
                                    Kcal: ${item.calories.toFixed(0)} | 
                                    B: ${item.protein.toFixed(1)}g | 
                                    W: ${item.carbs.toFixed(1)}g | 
                                    T: ${item.fat.toFixed(1)}g
                                </p>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>

                <div style="background-color: #F9FAFB; border: 1px solid #E5E7EB; padding: 20px; border-radius: 12px; margin-top: 30px;">
                     <h2 style="font-size: 1.5rem; font-weight: bold; color: #1F2937; margin-bottom: 15px; text-align: center;">PODSUMOWANIE DNIA</h2>
                     <div style="display: grid; grid-template-columns: 1fr; gap: 12px; font-size: 1.1rem; text-align: center; color: #111827;">
                        <p><strong>Suma Kalorii:</strong> ${totals.calories.toFixed(0)} kcal</p>
                        <p><strong>Suma Białka:</strong> ${totals.protein.toFixed(0)} g</p>
                        <p><strong>Suma Węglowodanów:</strong> ${totals.carbs.toFixed(0)} g</p>
                        <p><strong>Suma Tłuszczów:</strong> ${totals.fat.toFixed(0)} g</p>
                    </div>
                </div>
            `;
            
            printableArea.innerHTML = printableHTML;
            document.body.appendChild(printableArea);

            try {
                const { jsPDF } = window.jspdf;
                const canvas = await html2canvas(printableArea, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`plan-zywieniowy-${today.replace(/\./g, '-')}.pdf`);
                showToast("PDF został pomyślnie wygenerowany!", 'success');
            } catch (error) {
                console.error("Błąd podczas generowania PDF:", error);
                showToast("Wystąpił błąd podczas generowania PDF.");
            } finally {
                document.body.removeChild(printableArea);
                exportPdfBtn.disabled = (dailyPlan.length === 0);
                exportPdfBtn.textContent = originalBtnText;
            }
        }


        function saveComposedMeal() {
            const mealNameInput = document.getElementById('composer-meal-name');
            const originalNameInput = document.getElementById('composer-original-name');
            
            const newName = mealNameInput.value.trim();
            const originalName = originalNameInput.value.trim();
            
            if (!newName) {
                showToast('Proszę nadać nazwę posiłkowi.');
                return;
            }

            // Sprawdź, czy nazwa już istnieje ORAZ czy nie jest to nazwa edytowanego produktu
            if (newName !== originalName && foodProducts.some(p => p.name.toLowerCase() === newName.toLowerCase())) {
                showToast('Produkt o tej nazwie już istnieje.');
                return;
            }

            const rows = document.querySelectorAll('.composer-row');
            let total = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            let ingredients = []; // <-- NOWA ZMIENNA: Przechowuje składniki
            let ingredientCount = 0;

            rows.forEach(row => {
                const searchInput = row.querySelector('.composer-search-input');
                const amountInput = row.querySelector('input[type="number"]');
                const amount = parseFloat(amountInput.value);
                const productJSON = searchInput.dataset.selectedProduct;
                 if (productJSON && searchInput.value && amount > 0) {
                    ingredientCount++;
                    const product = JSON.parse(productJSON);
                     if(product && product.name === searchInput.value){
                        const factor = amount / 100;
                        total.calories += product.calories * factor;
                        total.protein += product.protein * factor;
                        total.carbs += product.carbs * factor;
                        total.fat += product.fat * factor;
                        
                        // Dodaj składnik do listy
                        ingredients.push({ name: product.name, amount: amount });
                    }
                }
            });

            if (ingredientCount === 0) {
                showToast('Proszę dodać przynajmniej jeden składnik.');
                return;
            }

            const composedProductData = {
                name: newName,
                category: 'Posiłki skomponowane',
                calories: Math.round(total.calories),
                protein: parseFloat(total.protein.toFixed(1)),
                carbs: parseFloat(total.carbs.toFixed(1)),
                fat: parseFloat(total.fat.toFixed(1)),
                isComposed: true, // <-- NOWA FLAGA
                ingredients: ingredients // <-- NOWA LISTA SKŁADNIKÓW
            };

            if (originalName) {
                // Tryb edycji: Znajdź i zaktualizuj
                const index = customProducts.findIndex(p => p.name === originalName);
                if (index > -1) {
                    customProducts[index] = composedProductData;
                    showToast('Posiłek został zaktualizowany!', 'success');
                } else {
                    // Nie znaleziono starego, zapisz jako nowy (fallback)
                    customProducts.push(composedProductData);
                    showToast('Posiłek został zapisany jako nowy produkt!', 'success');
                }
            } else {
                // Tryb tworzenia: Dodaj nowy
                customProducts.push(composedProductData);
                showToast('Posiłek został zapisany jako nowy produkt!', 'success');
            }

            saveCustomProducts(); // Zapisz zmiany (to również zaktualizuje foodProducts)
            
            mealNameInput.value = '';
            originalNameInput.value = '';
            mealComposerModal.classList.add('hidden');
        }

        function showMainSuggestions() {
            const searchTerm = productSearchInput.value.toLowerCase();
            productSuggestionsContainer.innerHTML = '';
            if (searchTerm.length === 0) {
                productSuggestionsContainer.classList.add('hidden');
                return;
            }
            const filtered = sortedFoodProducts.filter(p => p.name.toLowerCase().includes(searchTerm));
            if (filtered.length > 0) {
                productSuggestionsContainer.classList.remove('hidden');
                filtered.slice(0, 50).forEach(product => {
                    const item = document.createElement('div');
                    item.textContent = product.name;
                    item.className = 'suggestion-item';
                    item.addEventListener('mousedown', () => {
                        productSearchInput.value = product.name;
                        currentlySelectedProduct = product;
                        productSuggestionsContainer.classList.add('hidden');
                        const amountInput = document.getElementById('product-amount');
                        if (product.isComposed) { // <-- NOWA LOGIKA
                            amountInput.placeholder = 'Ilość (porcji)';
                        } else if (product.unit === 'szt') {
                            amountInput.placeholder = 'Ilość (szt.)';
                        } else {
                            amountInput.placeholder = 'Ilość (g)';
                        }
                    });
                    productSuggestionsContainer.appendChild(item);
                });
            } else {
                productSuggestionsContainer.classList.add('hidden');
            }
        }

        function populateProductListModal() {
            modalProductListContent.innerHTML = '';
            const categories = [...new Set(sortedFoodProducts.map(p => p.category))];
            
            const customCategoryName = 'Posiłki skomponowane'; // <-- ZMIANA
            if (categories.includes(customCategoryName)) {
                categories.splice(categories.indexOf(customCategoryName), 1);
                categories.unshift(customCategoryName); // Przesuń na początek
            }

            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = "border-b border-gray-700"; // Dodajemy separator dla estetyki

                // ZMIANA: Zamiast statycznego h4, tworzymy button (nagłówek akordeonu)
                const categoryHeader = document.createElement('button');
                // Domyślnie zwinięte (klasa 'collapsed')
                categoryHeader.className = 'product-category-header flex justify-between items-center w-full p-3 text-left hover:bg-gray-700 transition-colors collapsed'; 
                const categoryId = `category-content-${category.replace(/[^a-zA-Z0-9]/g, '-')}`; // Bezpieczniejsze ID
                categoryHeader.dataset.targetId = categoryId;
                categoryHeader.innerHTML = `
                    <h4 class="text-lg font-bold text-purple-300">${category}</h4>
                    <svg xmlns="http://www.w3.org/2000/svg" class="chevron h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                `;

                // ZMIANA: Tworzymy kontener na produkty (treść akordeonu)
                const contentDiv = document.createElement('div');
                contentDiv.id = categoryId;
                contentDiv.className = 'product-category-content'; // Styl CSS dla zwijania
                
                const productGrid = document.createElement('div');
                productGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-2 p-4'; // Dodano padding

                const productsInCategory = sortedFoodProducts.filter(p => p.category === category);
                productsInCategory.forEach(product => {
                    const productItem = document.createElement('button');
                    productItem.className = 'text-left p-2 rounded hover:bg-gray-700 transition-colors text-sm';
                    productItem.textContent = product.name;
                    productItem.dataset.productName = product.name;

                    // ZMIANA: Zastępujemy sam 'productItem' nową strukturą
                    const productWrapper = document.createElement('div');
                    productWrapper.className = 'flex justify-between items-center rounded hover:bg-gray-700 transition-colors group'; // 'group' dla efektu hover

                    const productButton = document.createElement('button');
                    productButton.className = 'text-left text-sm flex-grow p-2';
                    productButton.textContent = product.name;
                    productButton.dataset.productName = product.name;
                    
                    productWrapper.appendChild(productButton);

                    // **** START POPRAWKI BŁĘDU #3 ****
                    // Sprawdź, czy produkt jest produktem własnym (nie ma go w bazie początkowej)
                    const isCustom = !initialFoodProducts.some(p => p.name.toLowerCase() === product.name.toLowerCase());
                    // **** KONIEC POPRAWKI BŁĘDU #3 ****

                    if (isCustom) {
                        // NOWA LOGIKA: Dodaj przycisk Edytuj, jeśli posiłek jest skomponowany
                        if (product.isComposed) {
                            const editButton = document.createElement('button');
                            editButton.className = 'edit-composed-meal-btn text-cyan-400 hover:text-cyan-300 p-1 opacity-0 group-hover:opacity-100 transition-opacity mr-1';
                            editButton.dataset.productName = product.name;
                            editButton.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            `;
                            productWrapper.appendChild(editButton);
                        }

                        const deleteButton = document.createElement('button');
                        deleteButton.className = 'delete-custom-product-btn text-red-400 hover:text-red-300 p-1 opacity-0 group-hover:opacity-100 transition-opacity mr-2'; // Ukryty, pojawia się na hover
                        deleteButton.dataset.productNameToDelete = product.name;
                        deleteButton.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        `;
                        productWrapper.appendChild(deleteButton);
                    }
                    
                    productGrid.appendChild(productWrapper); // Dodaj wrapper zamiast item
                });

                contentDiv.appendChild(productGrid); // Włóż siatkę do zwijanej treści
                
                categoryDiv.appendChild(categoryHeader); // Dodaj nagłówek
                categoryDiv.appendChild(contentDiv); // Dodaj treść
                modalProductListContent.appendChild(categoryDiv);
            });
        }


        // --- INICJALIZACJA ---
        document.addEventListener('DOMContentLoaded', () => {
            loadCustomProducts();
            loadDailyPlan();
            loadUserData();
            renderMealList();
            updateSummary();


            calculateBtn.addEventListener('click', calculateNeeds);
            editDataBtn.addEventListener('click', () => {
                document.getElementById('user-data').classList.remove('hidden');
                document.getElementById('user-profile').classList.add('hidden');
                resultsSection.classList.add('hidden');
                plannerSection.classList.add('hidden');
                principlesSection.classList.add('hidden');
                supplementationSection.classList.add('hidden');
                hydrationSection.classList.add('hidden');
            });
            clearDataBtn.addEventListener('click', clearUserData);
            clearDayBtn.addEventListener('click', clearDailyPlan);
            addMealSeparatorBtn.addEventListener('click', addMealSeparator);

            addProductBtn.addEventListener('click', addProductToPlan);
            exportPdfBtn.addEventListener('click', exportToPDF);
            document.getElementById('meal-list').addEventListener('click', handleMealListClick);
            document.getElementById('meal-list').addEventListener('input', handleAmountChange); // POPRAWKA BŁĘDU #1 - ten listener obsługuje teraz puste pola
            // ZMIANA: Dodano nasłuchiwanie na zmianę nazwy posiłku
            document.getElementById('meal-list').addEventListener('input', handleMealNameChange);
            
            productSearchInput.addEventListener('input', showMainSuggestions);
            
            document.querySelectorAll('.accordion-container').forEach(container => {
                container.addEventListener('click', handleAccordionClick);
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.relative')) {
                    document.querySelectorAll('.suggestions-container').forEach(c => c.classList.add('hidden'));
                }
            });

            // Event Listeners dla modala prostego produktu
            openModalBtn.addEventListener('click', () => {
                populateCategoryDropdown(); // ZMIANA: Wypełnij listę kategorii przy otwieraniu
                customProductModal.classList.remove('hidden')
            });
            closeModalBtn.addEventListener('click', () => customProductModal.classList.add('hidden'));
            customProductModal.addEventListener('click', (e) => {
                if (e.target.id === 'custom-product-modal') {
                    customProductModal.classList.add('hidden');
                }
            });
            customProductForm.addEventListener('submit', handleNewProductSubmit);
            
            // ZMIANA START: Listener do pokazywania/ukrywania pola na nową kategorię
            document.getElementById('new-product-category').addEventListener('change', (e) => {
                const newCategoryWrapper = document.getElementById('new-category-wrapper');
                if (e.target.value === '__new__') {
                    newCategoryWrapper.classList.remove('hidden');
                } else {
                    newCategoryWrapper.classList.add('hidden');
                }
            });
            // ZMIANA KONIEC

            // Event Listeners dla kompozytora posiłków
            openComposerBtn.addEventListener('click', () => {
                initializeComposer(); // Wywołaj bez argumentu, aby wyczyścić formularz
                mealComposerModal.classList.remove('hidden');
            });
            closeComposerBtn.addEventListener('click', () => mealComposerModal.classList.add('hidden'));
            mealComposerModal.addEventListener('click', (e) => {
                if (e.target.id === 'meal-composer-modal') {
                    mealComposerModal.classList.add('hidden');
                }
            });
            saveComposedMealBtn.addEventListener('click', saveComposedMeal);

             // Event Listeners dla modala z listą produktów
            showProductListBtn.addEventListener('click', () => {
                populateProductListModal();
                productListModal.classList.remove('hidden');
            });
            closeProductListBtn.addEventListener('click', () => productListModal.classList.add('hidden'));
            productListModal.addEventListener('click', (e) => {
                if (e.target.id === 'product-list-modal') {
                    productListModal.classList.add('hidden');
                }
            });
            modalProductListContent.addEventListener('click', (e) => {
                // NOWA LOGIKA: Sprawdź, czy kliknięto przycisk usuwania
                const deleteBtn = e.target.closest('.delete-custom-product-btn');
                if (deleteBtn) {
                    e.stopPropagation(); // Zapobiegaj wybraniu produktu
                    const productName = deleteBtn.dataset.productNameToDelete;
                    
                    // Znajdź i usuń z 'customProducts'
                    const indexInCustom = customProducts.findIndex(p => p.name === productName);
                    if (indexInCustom > -1) {
                        customProducts.splice(indexInCustom, 1);
                    }
                    
                    // Zapisz (to wywoła 'updateSortedProducts')
                    saveCustomProducts(); 
                    
                    // Przerenderuj listę w modalu
                    populateProductListModal();
                    showToast(`Produkt "${productName}" został usunięty.`, 'success');
                    
                    return; // Zakończ
                }

                // NOWA LOGIKA: Sprawdź, czy kliknięto przycisk edycji
                const editBtn = e.target.closest('.edit-composed-meal-btn');
                if (editBtn) {
                    e.stopPropagation(); // Zapobiegaj wybraniu produktu
                    const productName = editBtn.dataset.productName;
                    const productToEdit = customProducts.find(p => p.name === productName);
                    
                    if (productToEdit) {
                        initializeComposer(productToEdit); // Otwórz kompozytor z danymi
                        mealComposerModal.classList.remove('hidden');
                        productListModal.classList.add('hidden'); // Zamknij listę produktów
                    }
                    
                    return; // Zakończ
                }


                // Sprawdź, czy kliknięto przycisk produktu
                const button = e.target.closest('button[data-product-name]');
                if (button) {
                    const productName = button.dataset.productName;
                    const product = foodProducts.find(p => p.name === productName);
                    
                    if (product) {
                        // --- NOWA LOGIKA ROZDZIELAJĄCA ---
                        if (activeComposerInput) {
                            // Przypadek 1: Wybieramy produkt dla kompozytora posiłków
                            activeComposerInput.value = product.name;
                            activeComposerInput.dataset.selectedProduct = JSON.stringify(product); // Zapisz dane produktu w polu
                            
                            updateComposerSummary(); // Zaktualizuj sumę makro w kompozytorze
                            
                            productListModal.classList.add('hidden'); // Zamknij modal
                            activeComposerInput = null; // Zresetuj globalny wskaźnik
                        } else {
                            // Przypadek 2: Wybieramy produkt dla głównego planera (stare zachowanie)
                            productSearchInput.value = product.name;
                            currentlySelectedProduct = product;
                            productListModal.classList.add('hidden');
                            const amountInput = document.getElementById('product-amount');
                            
                            if (product.isComposed) { // <-- NOWA LOGIKA
                                amountInput.placeholder = 'Ilość (porcji)';
                            } else if (product.unit === 'szt') {
                                amountInput.placeholder = 'Ilość (szt.)';
                            } else {
                                amountInput.placeholder = 'Ilość (g)';
                            }

                            amountInput.focus();
                        }
                        // --- KONIEC NOWEJ LOGIKI ---
                    }
                }

                // NOWA LOGIKA: Sprawdź, czy kliknięto nagłówek kategorii
                const header = e.target.closest('.product-category-header');
                if (header) {
                    const contentId = header.dataset.targetId;
                    const content = document.getElementById(contentId);
                    if (content) {
                        if (content.style.maxHeight) {
                            // Jest otwarty -> zamknij
                            content.style.maxHeight = null;
                            header.classList.add('collapsed');
                        } else {
                            // Jest zamknięty -> otwórz
                            content.style.maxHeight = content.scrollHeight + "px";
                            header.classList.remove('collapsed');
                        }
                    }
                }
            });

        });
    </script>
</body>
</html>
